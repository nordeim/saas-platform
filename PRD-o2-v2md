TechFlow Solutions
Enterprise SaaS Platform - Project Requirements Document (PRD)
Version 2.0 | December 22, 2025
Pragmatic Edition - Django 6.0
<div align="center">
A Singapore-First, Production-Ready SaaS Platform

Built with Django 6.0 • Next.js 15 • PostgreSQL 17 • Python 3.13

</div>
Document Control
Attribute	Value
Version	2.0
Status	Draft for Review
Created	December 22, 2025
Author	Technical Architecture Team
Framework	Django 6.0 (Released Dec 3, 2025)
Language	English Only
Region	Singapore (Primary), APAC (Secondary)
Table of Contents
Executive Summary
Business Requirements
Technical Architecture
Database Architecture
Backend Architecture
Frontend Architecture
API Specifications
Security Architecture
Singapore Compliance
Infrastructure & Deployment
Development Phases
Testing Strategy
Operations & Monitoring
Risk Management
Appendices
1. Executive Summary
1.1 Project Overview
TechFlow Solutions is building a modern enterprise SaaS platform for workflow automation, targeting Singapore SMEs and enterprises. This PRD defines a pragmatic, achievable architecture that prioritizes:

Regulatory Compliance: PDPA-compliant from day one
Local Market Fit: PayNow integration, Singapore timezone defaults
Technical Excellence: Django 6.0's latest features
Cost Efficiency: Phased infrastructure scaling
Time-to-Market: 16-week MVP timeline
1.2 Key Decisions
Decision	Choice	Rationale
Backend Framework	Django 6.0	Latest LTS, built-in CSP, Tasks framework
Frontend Framework	Next.js 15	React Server Components, excellent DX
Primary Language	English only	Reduces complexity, faster delivery
Database	PostgreSQL 17	Robust, excellent Django integration
Task Queue	Django Tasks + Celery	Django Tasks for simple, Celery for complex
Primary Payment	PayNow + Stripe	Singapore-first, international backup
Initial Infrastructure	Docker Compose	Kubernetes deferred to Phase 3
Hosting Region	AWS ap-southeast-1	Singapore data residency
1.3 Success Criteria
Metric	Target	Measurement
MVP Launch	Week 16	Feature completion
Page Load (LCP)	< 2.0s	Lighthouse scores
API Response (p95)	< 200ms	Prometheus metrics
Uptime	99.9%	Monitoring alerts
PDPA Compliance	100%	Compliance audit
Monthly Infrastructure Cost	< S$400	AWS billing
1.4 Technology Stack Summary
YAML

Backend:
  Runtime: Python 3.13
  Framework: Django 6.0
  API: Django REST Framework 3.15
  Tasks: Django Tasks + Celery 5.4
  WebSocket: Django Channels 4.2
  Cache: Redis 7.4

Frontend:
  Runtime: Node.js 22 LTS
  Framework: Next.js 15.1
  UI: React 19 + Tailwind CSS 4.0
  State: Zustand 5 + TanStack Query 5
  Forms: React Hook Form 7 + Zod 3

Database:
  Primary: PostgreSQL 17
  Cache/Queue: Redis 7.4
  Storage: AWS S3

Infrastructure:
  Containers: Docker 27
  Proxy: Caddy 2.8
  CI/CD: GitHub Actions
  Monitoring: Sentry + CloudWatch
2. Business Requirements
2.1 Target Market
Primary: Singapore SMEs (20-500 employees)
Secondary: Singapore Enterprises (500+ employees)
Tertiary: APAC expansion (Malaysia, Indonesia, Thailand)

2.2 User Personas
Persona	Description	Key Needs
Operations Manager	Day-to-day platform user	Easy workflow creation, clear dashboards
IT Administrator	Technical setup and integration	API access, SSO configuration, audit logs
Finance Controller	Billing and compliance oversight	Invoice management, usage reports
Business Owner	Strategic decision maker	ROI visibility, team productivity metrics
2.3 Core Feature Set (MVP)
2.3.1 Authentication & Authorization
Feature	Priority	Description
Email/Password Auth	P0	Standard authentication with email verification
Magic Link Login	P0	Passwordless option for convenience
Multi-Factor Auth	P0	TOTP-based 2FA for security
OAuth (Google)	P1	Social login for faster onboarding
SingPass Integration	P2	Government digital identity (post-MVP)
Role-Based Access	P0	Owner, Admin, Member, Viewer roles
2.3.2 Organization Management
Feature	Priority	Description
Organization CRUD	P0	Create, manage, delete organizations
Team Invitations	P0	Email-based team member invites
Member Management	P0	Role assignment, deactivation
Organization Settings	P0	Timezone, preferences, branding
Billing Information	P0	Company details, UEN, GST registration
2.3.3 Workflow Automation
Feature	Priority	Description
Visual Workflow Builder	P0	Drag-and-drop workflow creation
Template Library	P1	Pre-built workflow templates
Trigger Configuration	P0	Schedule, webhook, manual triggers
Action Library	P0	Email, HTTP request, data operations
Execution History	P0	Logs, status, error tracking
Version Control	P2	Workflow versioning and rollback
2.3.4 Billing & Payments
Feature	Priority	Description
PayNow Integration	P0	Singapore's primary payment method
Stripe Integration	P0	Credit cards, international payments
Subscription Management	P0	Plan selection, upgrades, downgrades
Invoice Generation	P0	GST-compliant invoices
Usage Tracking	P0	API calls, storage, team members
2.3.5 Analytics & Reporting
Feature	Priority	Description
Usage Dashboard	P0	Real-time usage metrics
Workflow Analytics	P1	Execution success rates, performance
Export Reports	P1	CSV, PDF export functionality
Audit Logs	P0	Compliance-ready activity logs
2.4 Pricing Tiers
Tier	Price (SGD/mo)	Users	Workflows	API Calls	Storage
Free	$0	3	5	1,000	500 MB
Starter	$49	10	25	10,000	5 GB
Professional	$199	50	100	100,000	50 GB
Enterprise	Custom	Unlimited	Unlimited	Unlimited	Custom
3. Technical Architecture
3.1 System Overview
text

┌─────────────────────────────────────────────────────────────────────────────┐
│                              EDGE LAYER                                      │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │  CloudFlare (CDN, DDoS Protection, WAF)                              │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────────┘
                                      │
                                      ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           APPLICATION LAYER                                  │
│                                                                              │
│  ┌──────────────────────┐    ┌──────────────────────┐                       │
│  │   Next.js 15         │    │   Django 6.0          │                       │
│  │   (Frontend SSR)     │    │   (API + WebSocket)   │                       │
│  │                      │    │                       │                       │
│  │   • React 19         │    │   • REST API          │                       │
│  │   • Server Components│    │   • Django Channels   │                       │
│  │   • Tailwind 4.0     │◄──►│   • Django Tasks      │                       │
│  │   • TypeScript 5.6   │    │   • Celery Workers    │                       │
│  └──────────────────────┘    └──────────────────────┘                       │
│                                      │                                       │
└──────────────────────────────────────┼───────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                             DATA LAYER                                       │
│                                                                              │
│  ┌──────────────────────┐    ┌──────────────────────┐    ┌────────────────┐ │
│  │   PostgreSQL 17      │    │   Redis 7.4          │    │   AWS S3       │ │
│  │                      │    │                       │    │                │ │
│  │   • Primary data     │    │   • Cache             │    │   • Files      │ │
│  │   • Full-text search │    │   • Sessions          │    │   • Media      │ │
│  │   • Audit logs       │    │   • Task queue        │    │   • Backups    │ │
│  └──────────────────────┘    │   • WebSocket state   │    └────────────────┘ │
│                              └──────────────────────┘                        │
└─────────────────────────────────────────────────────────────────────────────┘
                                       │
                                       ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         EXTERNAL SERVICES                                    │
│                                                                              │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐  ┌────────────┐            │
│  │  Stripe    │  │  PayNow    │  │  SendGrid  │  │  Sentry    │            │
│  │  Payments  │  │  (Bank)    │  │  Email     │  │  Errors    │            │
│  └────────────┘  └────────────┘  └────────────┘  └────────────┘            │
└─────────────────────────────────────────────────────────────────────────────┘
3.2 Django 6.0 Feature Utilization
Django 6.0 Feature	How We Use It
Content Security Policy	Built-in CSP headers via ContentSecurityPolicyMiddleware
Template Partials	Component-like templates with {% partialdef %}
Background Tasks	Simple async operations (email, notifications)
Modern Email API	All email handling with email.message.EmailMessage
AsyncPaginator	Async API endpoints with pagination
StringAgg	Cross-database string aggregation
3.3 Directory Structure
text

techflow/
├── backend/                          # Django 6.0 Backend
│   ├── config/                       # Project configuration
│   │   ├── __init__.py
│   │   ├── settings/
│   │   │   ├── __init__.py
│   │   │   ├── base.py              # Base settings
│   │   │   ├── development.py       # Dev overrides
│   │   │   ├── production.py        # Prod overrides
│   │   │   └── test.py              # Test settings
│   │   ├── urls.py                  # URL configuration
│   │   ├── wsgi.py                  # WSGI entry
│   │   ├── asgi.py                  # ASGI entry (Channels)
│   │   └── celery.py                # Celery configuration
│   │
│   ├── apps/                         # Django applications
│   │   ├── core/                    # Shared utilities
│   │   │   ├── models.py            # Abstract base models
│   │   │   ├── permissions.py       # Custom permissions
│   │   │   ├── pagination.py        # Custom pagination
│   │   │   ├── middleware.py        # Custom middleware
│   │   │   └── exceptions.py        # Custom exceptions
│   │   │
│   │   ├── identity/                # Authentication domain
│   │   │   ├── models.py            # User, Session
│   │   │   ├── views.py             # Auth views
│   │   │   ├── serializers.py       # Auth serializers
│   │   │   ├── tasks.py             # Auth background tasks
│   │   │   └── services/
│   │   │       ├── auth.py          # Auth service
│   │   │       └── mfa.py           # MFA service
│   │   │
│   │   ├── organizations/           # Organization domain
│   │   │   ├── models.py            # Organization, Member, Invitation
│   │   │   ├── views.py             # Org CRUD
│   │   │   ├── serializers.py       # Org serializers
│   │   │   └── services/
│   │   │       └── invitation.py    # Invitation logic
│   │   │
│   │   ├── billing/                 # Billing domain
│   │   │   ├── models.py            # Subscription, Invoice, Payment
│   │   │   ├── views.py             # Billing endpoints
│   │   │   ├── serializers.py       # Billing serializers
│   │   │   └── services/
│   │   │       ├── stripe.py        # Stripe integration
│   │   │       └── paynow.py        # PayNow integration
│   │   │
│   │   ├── workflows/               # Workflow domain
│   │   │   ├── models.py            # Workflow, Execution, Step
│   │   │   ├── views.py             # Workflow CRUD
│   │   │   ├── serializers.py       # Workflow serializers
│   │   │   ├── tasks.py             # Workflow execution tasks
│   │   │   └── engine/
│   │   │       ├── executor.py      # Workflow executor
│   │   │       └── actions/         # Action implementations
│   │   │
│   │   ├── analytics/               # Analytics domain
│   │   │   ├── models.py            # UsageRecord, Report
│   │   │   ├── views.py             # Analytics endpoints
│   │   │   └── services/
│   │   │       └── metrics.py       # Metrics calculation
│   │   │
│   │   ├── compliance/              # Singapore Compliance
│   │   │   ├── models.py            # Consent, AccessRequest, BreachIncident
│   │   │   ├── views.py             # Compliance endpoints
│   │   │   ├── services/
│   │   │   │   ├── pdpa.py          # PDPA service
│   │   │   │   └── audit.py         # Audit logging
│   │   │   └── tasks.py             # Compliance tasks
│   │   │
│   │   └── notifications/           # Notification domain
│   │       ├── models.py            # Notification
│   │       ├── consumers.py         # WebSocket consumers
│   │       └── tasks.py             # Notification tasks
│   │
│   ├── templates/                    # Django templates
│   │   ├── base.html
│   │   ├── emails/                  # Email templates
│   │   └── partials/                # Template partials (Django 6.0)
│   │
│   ├── static/                       # Static files
│   ├── media/                        # User uploads (dev only)
│   ├── requirements/
│   │   ├── base.txt
│   │   ├── development.txt
│   │   ├── production.txt
│   │   └── test.txt
│   ├── manage.py
│   ├── Dockerfile
│   └── pytest.ini
│
├── frontend/                         # Next.js 15 Frontend
│   ├── src/
│   │   ├── app/                     # App Router
│   │   │   ├── (auth)/              # Auth route group
│   │   │   │   ├── login/
│   │   │   │   ├── register/
│   │   │   │   └── verify/
│   │   │   ├── (dashboard)/         # Dashboard route group
│   │   │   │   ├── layout.tsx
│   │   │   │   ├── dashboard/
│   │   │   │   ├── workflows/
│   │   │   │   ├── team/
│   │   │   │   ├── billing/
│   │   │   │   └── settings/
│   │   │   ├── (marketing)/         # Public pages
│   │   │   │   ├── page.tsx         # Homepage
│   │   │   │   ├── pricing/
│   │   │   │   ├── features/
│   │   │   │   └── contact/
│   │   │   ├── layout.tsx
│   │   │   ├── error.tsx
│   │   │   ├── not-found.tsx
│   │   │   └── global-error.tsx
│   │   │
│   │   ├── components/
│   │   │   ├── ui/                  # Base UI components
│   │   │   ├── forms/               # Form components
│   │   │   ├── layouts/             # Layout components
│   │   │   └── features/            # Feature-specific
│   │   │
│   │   ├── lib/
│   │   │   ├── api/                 # API client
│   │   │   ├── hooks/               # Custom hooks
│   │   │   ├── stores/              # Zustand stores
│   │   │   ├── utils/               # Utilities
│   │   │   └── types/               # TypeScript types
│   │   │
│   │   └── styles/
│   │       └── globals.css
│   │
│   ├── public/
│   ├── package.json
│   ├── next.config.ts
│   ├── tailwind.config.ts
│   ├── tsconfig.json
│   └── Dockerfile
│
├── infrastructure/
│   ├── docker/
│   │   ├── docker-compose.yml       # Development
│   │   ├── docker-compose.prod.yml  # Production
│   │   └── Caddyfile                # Reverse proxy
│   ├── scripts/
│   │   ├── setup.sh                 # Initial setup
│   │   ├── deploy.sh                # Deployment script
│   │   └── backup.sh                # Database backup
│   └── terraform/                   # IaC (Phase 2+)
│
├── docs/
│   ├── architecture/
│   ├── api/
│   ├── deployment/
│   └── compliance/
│
├── .github/
│   ├── workflows/
│   │   ├── ci.yml                   # CI pipeline
│   │   ├── cd.yml                   # CD pipeline
│   │   └── security.yml             # Security scans
│   ├── ISSUE_TEMPLATE/
│   └── PULL_REQUEST_TEMPLATE.md
│
├── .env.example
├── Makefile
└── README.md
4. Database Architecture
4.1 Schema Overview
SQL

-- ============================================
-- DATABASE INITIALIZATION
-- PostgreSQL 17
-- ============================================

-- Extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";
CREATE EXTENSION IF NOT EXISTS "pg_trgm";      -- Fuzzy text search
CREATE EXTENSION IF NOT EXISTS "btree_gist";   -- Range constraints

-- Custom Types
CREATE TYPE user_role AS ENUM ('owner', 'admin', 'member', 'viewer');
CREATE TYPE subscription_status AS ENUM (
    'trialing', 'active', 'past_due', 'canceled', 'incomplete'
);
CREATE TYPE subscription_tier AS ENUM ('free', 'starter', 'professional', 'enterprise');
CREATE TYPE payment_method AS ENUM ('stripe', 'paynow', 'bank_transfer');
CREATE TYPE payment_status AS ENUM ('pending', 'completed', 'failed', 'refunded');
CREATE TYPE workflow_status AS ENUM ('draft', 'active', 'paused', 'archived');
CREATE TYPE execution_status AS ENUM ('pending', 'running', 'completed', 'failed', 'canceled');
CREATE TYPE consent_type AS ENUM (
    'marketing_email', 'marketing_sms', 'data_analytics', 
    'third_party_sharing', 'cross_border_transfer'
);
CREATE TYPE access_request_type AS ENUM ('access', 'correction', 'deletion', 'portability');
CREATE TYPE access_request_status AS ENUM (
    'pending', 'identity_verification', 'in_progress', 'completed', 'rejected'
);
4.2 Core Tables
SQL

-- ============================================
-- IDENTITY DOMAIN
-- ============================================

CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    email VARCHAR(255) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    
    -- Profile
    full_name VARCHAR(255) NOT NULL,
    avatar_url TEXT,
    phone_number VARCHAR(20),
    
    -- Status
    is_active BOOLEAN DEFAULT true,
    is_staff BOOLEAN DEFAULT false,
    is_superuser BOOLEAN DEFAULT false,
    email_verified BOOLEAN DEFAULT false,
    
    -- Security
    mfa_enabled BOOLEAN DEFAULT false,
    mfa_secret VARCHAR(255),
    failed_login_attempts INTEGER DEFAULT 0,
    locked_until TIMESTAMPTZ,
    
    -- Preferences
    timezone VARCHAR(50) DEFAULT 'Asia/Singapore',
    preferences JSONB DEFAULT '{}',
    
    -- Timestamps
    last_login_at TIMESTAMPTZ,
    password_changed_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- Constraints
    CONSTRAINT valid_email CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

CREATE TABLE sessions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    
    -- Context
    ip_address INET,
    user_agent TEXT,
    device_type VARCHAR(50),
    
    -- Validity
    expires_at TIMESTAMPTZ NOT NULL,
    last_activity_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- Index for cleanup
    CONSTRAINT valid_expiry CHECK (expires_at > created_at)
);

CREATE TABLE magic_links (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    purpose VARCHAR(50) NOT NULL, -- 'login', 'email_verify', 'password_reset'
    
    expires_at TIMESTAMPTZ NOT NULL,
    used_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- ORGANIZATION DOMAIN
-- ============================================

CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Identity
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) UNIQUE NOT NULL,
    logo_url TEXT,
    
    -- Singapore Business Info
    uen VARCHAR(20),                          -- Unique Entity Number
    gst_registered BOOLEAN DEFAULT false,
    gst_number VARCHAR(20),
    
    -- Contact
    billing_email VARCHAR(255),
    billing_address JSONB,
    
    -- Settings
    timezone VARCHAR(50) DEFAULT 'Asia/Singapore',
    settings JSONB DEFAULT '{}',
    
    -- Status
    is_active BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMPTZ,
    
    -- Constraints
    CONSTRAINT valid_slug CHECK (slug ~ '^[a-z0-9-]+$'),
    CONSTRAINT valid_uen CHECK (
        uen IS NULL OR
        uen ~ '^[0-9]{8,9}[A-Z]$' OR           -- Local Company/Business
        uen ~ '^[TSRF][0-9]{2}[A-Z]{2}[0-9]{4}[A-Z]$'  -- Foreign/Others
    )
);

CREATE TABLE organization_members (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    role user_role NOT NULL DEFAULT 'member',
    
    -- Invitation tracking
    invited_by UUID REFERENCES users(id),
    invitation_accepted_at TIMESTAMPTZ,
    
    -- Status
    is_active BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(organization_id, user_id)
);

CREATE TABLE invitations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    email VARCHAR(255) NOT NULL,
    role user_role NOT NULL DEFAULT 'member',
    token_hash VARCHAR(255) UNIQUE NOT NULL,
    
    -- Status
    status VARCHAR(20) DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'expired', 'revoked')),
    
    -- Tracking
    invited_by UUID NOT NULL REFERENCES users(id),
    accepted_by UUID REFERENCES users(id),
    
    -- Validity
    expires_at TIMESTAMPTZ NOT NULL,
    accepted_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- BILLING DOMAIN
-- ============================================

CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID UNIQUE NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Plan
    tier subscription_tier NOT NULL DEFAULT 'free',
    status subscription_status NOT NULL DEFAULT 'active',
    
    -- External References
    stripe_subscription_id VARCHAR(255) UNIQUE,
    stripe_customer_id VARCHAR(255),
    
    -- Billing Period
    current_period_start TIMESTAMPTZ,
    current_period_end TIMESTAMPTZ,
    
    -- Trial
    trial_start TIMESTAMPTZ,
    trial_end TIMESTAMPTZ,
    
    -- Cancellation
    cancel_at_period_end BOOLEAN DEFAULT false,
    canceled_at TIMESTAMPTZ,
    
    -- Limits (denormalized for performance)
    max_users INTEGER NOT NULL DEFAULT 3,
    max_workflows INTEGER NOT NULL DEFAULT 5,
    max_api_calls INTEGER NOT NULL DEFAULT 1000,
    max_storage_bytes BIGINT NOT NULL DEFAULT 524288000, -- 500 MB
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE payments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    subscription_id UUID REFERENCES subscriptions(id),
    
    -- Payment Details
    method payment_method NOT NULL,
    status payment_status NOT NULL DEFAULT 'pending',
    
    -- Amount
    amount_cents INTEGER NOT NULL,
    currency CHAR(3) NOT NULL DEFAULT 'SGD',
    
    -- External References
    stripe_payment_id VARCHAR(255),
    paynow_reference VARCHAR(255),
    
    -- Metadata
    description TEXT,
    receipt_url TEXT,
    
    -- Timestamps
    paid_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE invoices (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    payment_id UUID REFERENCES payments(id),
    
    -- Invoice Details
    invoice_number VARCHAR(50) UNIQUE NOT NULL,
    
    -- Amounts (in cents)
    subtotal_cents INTEGER NOT NULL,
    tax_cents INTEGER NOT NULL DEFAULT 0,     -- GST
    total_cents INTEGER NOT NULL,
    
    tax_rate DECIMAL(5,4) DEFAULT 0.09,       -- Singapore GST 9%
    
    -- Line Items
    line_items JSONB NOT NULL DEFAULT '[]',
    
    -- Dates
    issued_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    due_at TIMESTAMPTZ,
    paid_at TIMESTAMPTZ,
    
    -- PDF
    pdf_url TEXT,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- WORKFLOW DOMAIN
-- ============================================

CREATE TABLE workflows (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Identity
    name VARCHAR(255) NOT NULL,
    description TEXT,
    
    -- Definition (JSON workflow definition)
    definition JSONB NOT NULL DEFAULT '{"nodes": [], "edges": []}',
    
    -- Status
    status workflow_status NOT NULL DEFAULT 'draft',
    
    -- Scheduling (cron expression)
    schedule VARCHAR(100),
    next_run_at TIMESTAMPTZ,
    
    -- Tracking
    created_by UUID NOT NULL REFERENCES users(id),
    last_modified_by UUID REFERENCES users(id),
    
    -- Stats
    total_executions INTEGER DEFAULT 0,
    successful_executions INTEGER DEFAULT 0,
    
    -- Timestamps
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    -- Unique name per organization
    UNIQUE(organization_id, name)
);

CREATE TABLE workflow_executions (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    workflow_id UUID NOT NULL REFERENCES workflows(id) ON DELETE CASCADE,
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Execution Details
    status execution_status NOT NULL DEFAULT 'pending',
    
    -- Input/Output
    input_data JSONB DEFAULT '{}',
    output_data JSONB,
    
    -- Error Handling
    error_message TEXT,
    error_details JSONB,
    
    -- Timing
    started_at TIMESTAMPTZ,
    completed_at TIMESTAMPTZ,
    duration_ms INTEGER,
    
    -- Trigger Info
    triggered_by VARCHAR(50), -- 'schedule', 'manual', 'webhook', 'api'
    triggered_by_user UUID REFERENCES users(id),
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- ANALYTICS DOMAIN
-- ============================================

CREATE TABLE usage_records (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    organization_id UUID NOT NULL REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Metric
    metric_type VARCHAR(50) NOT NULL, -- 'api_calls', 'workflow_executions', 'storage_bytes'
    quantity DECIMAL(12, 4) NOT NULL,
    
    -- Time Bucket
    recorded_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    period_start TIMESTAMPTZ NOT NULL,
    period_end TIMESTAMPTZ NOT NULL,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- Partition usage_records by month for performance
-- (Simplified - actual implementation would use native partitioning)

-- ============================================
-- COMPLIANCE DOMAIN (PDPA)
-- ============================================

CREATE TABLE pdpa_consents (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    
    consent_type consent_type NOT NULL,
    is_granted BOOLEAN NOT NULL DEFAULT false,
    
    -- Consent Evidence (PDPA requirement)
    consent_text TEXT NOT NULL,
    consent_version VARCHAR(20) NOT NULL,
    collection_method VARCHAR(50) NOT NULL, -- 'web_form', 'api', 'import'
    
    -- Context
    ip_address INET,
    user_agent TEXT,
    
    -- Timestamps
    granted_at TIMESTAMPTZ,
    withdrawn_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    
    UNIQUE(user_id, consent_type)
);

CREATE TABLE data_access_requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Reference
    reference_number VARCHAR(50) UNIQUE NOT NULL,
    
    -- Requester
    user_id UUID REFERENCES users(id),
    requester_email VARCHAR(255) NOT NULL,
    requester_name VARCHAR(255) NOT NULL,
    
    -- Request
    request_type access_request_type NOT NULL,
    request_details TEXT NOT NULL,
    
    -- Status
    status access_request_status NOT NULL DEFAULT 'pending',
    
    -- PDPA: 30-day response requirement
    submitted_at TIMESTAMPTZ NOT NULL DEFAULT CURRENT_TIMESTAMP,
    due_date TIMESTAMPTZ NOT NULL,
    completed_at TIMESTAMPTZ,
    
    -- Identity Verification
    identity_verified BOOLEAN DEFAULT false,
    verified_at TIMESTAMPTZ,
    verified_by UUID REFERENCES users(id),
    
    -- Response
    response_notes TEXT,
    response_files JSONB DEFAULT '[]', -- S3 paths
    
    -- Handling
    assigned_to UUID REFERENCES users(id),
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE audit_logs (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    
    -- Actor
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    organization_id UUID REFERENCES organizations(id) ON DELETE SET NULL,
    
    -- Action
    action VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL, -- 'auth', 'data', 'admin', 'billing'
    
    -- Resource
    resource_type VARCHAR(50),
    resource_id VARCHAR(255),
    
    -- Details
    details JSONB DEFAULT '{}',
    personal_data_accessed TEXT[], -- Fields accessed for PDPA compliance
    
    -- Context
    ip_address INET,
    user_agent TEXT,
    request_id VARCHAR(100),
    
    -- Chain (tamper detection)
    previous_hash VARCHAR(64),
    entry_hash VARCHAR(64),
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE notifications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    
    -- Content
    title VARCHAR(255) NOT NULL,
    body TEXT NOT NULL,
    type VARCHAR(50) NOT NULL,
    
    -- Action
    action_url TEXT,
    
    -- Status
    is_read BOOLEAN DEFAULT false,
    read_at TIMESTAMPTZ,
    
    created_at TIMESTAMPTZ DEFAULT CURRENT_TIMESTAMP
);

-- ============================================
-- INDEXES
-- ============================================

-- Users
CREATE INDEX idx_users_email ON users(lower(email));
CREATE INDEX idx_users_active ON users(is_active) WHERE is_active = true;

-- Sessions
CREATE INDEX idx_sessions_user ON sessions(user_id);
CREATE INDEX idx_sessions_token ON sessions(token_hash);
CREATE INDEX idx_sessions_expires ON sessions(expires_at) WHERE expires_at > CURRENT_TIMESTAMP;

-- Organizations
CREATE INDEX idx_orgs_slug ON organizations(slug);
CREATE INDEX idx_orgs_active ON organizations(is_active) WHERE is_active = true AND deleted_at IS NULL;

-- Members
CREATE INDEX idx_members_org ON organization_members(organization_id) WHERE is_active = true;
CREATE INDEX idx_members_user ON organization_members(user_id) WHERE is_active = true;

-- Subscriptions
CREATE INDEX idx_subs_org ON subscriptions(organization_id);
CREATE INDEX idx_subs_status ON subscriptions(status);
CREATE INDEX idx_subs_stripe ON subscriptions(stripe_subscription_id);

-- Workflows
CREATE INDEX idx_workflows_org ON workflows(organization_id);
CREATE INDEX idx_workflows_status ON workflows(organization_id, status);
CREATE INDEX idx_workflows_schedule ON workflows(next_run_at) WHERE status = 'active' AND schedule IS NOT NULL;

-- Executions
CREATE INDEX idx_executions_workflow ON workflow_executions(workflow_id);
CREATE INDEX idx_executions_status ON workflow_executions(organization_id, status, created_at DESC);

-- Usage
CREATE INDEX idx_usage_org_period ON usage_records(organization_id, period_start, period_end);
CREATE INDEX idx_usage_metric ON usage_records(metric_type, recorded_at);

-- Audit
CREATE INDEX idx_audit_org ON audit_logs(organization_id, created_at DESC);
CREATE INDEX idx_audit_user ON audit_logs(user_id, created_at DESC);
CREATE INDEX idx_audit_action ON audit_logs(action, created_at DESC);

-- Notifications
CREATE INDEX idx_notifications_user ON notifications(user_id, is_read, created_at DESC);

-- Full-text search
CREATE INDEX idx_workflows_search ON workflows USING gin(
    to_tsvector('english', name || ' ' || COALESCE(description, ''))
);

-- ============================================
-- TRIGGERS
-- ============================================

-- Auto-update updated_at
CREATE OR REPLACE FUNCTION update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_users_updated_at 
    BEFORE UPDATE ON users 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER trg_organizations_updated_at 
    BEFORE UPDATE ON organizations 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER trg_subscriptions_updated_at 
    BEFORE UPDATE ON subscriptions 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

CREATE TRIGGER trg_workflows_updated_at 
    BEFORE UPDATE ON workflows 
    FOR EACH ROW EXECUTE FUNCTION update_updated_at();

-- Auto-set data access request due date (30 days per PDPA)
CREATE OR REPLACE FUNCTION set_access_request_due_date()
RETURNS TRIGGER AS $$
BEGIN
    NEW.due_date = NEW.submitted_at + INTERVAL '30 days';
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_access_request_due_date
    BEFORE INSERT ON data_access_requests
    FOR EACH ROW EXECUTE FUNCTION set_access_request_due_date();

-- Auto-generate invoice number
CREATE OR REPLACE FUNCTION generate_invoice_number()
RETURNS TRIGGER AS $$
DECLARE
    year_month TEXT;
    sequence_num INTEGER;
BEGIN
    year_month := TO_CHAR(CURRENT_DATE, 'YYYYMM');
    
    SELECT COALESCE(MAX(CAST(SUBSTRING(invoice_number FROM 8) AS INTEGER)), 0) + 1
    INTO sequence_num
    FROM invoices
    WHERE invoice_number LIKE 'TF' || year_month || '%';
    
    NEW.invoice_number := 'TF' || year_month || LPAD(sequence_num::TEXT, 4, '0');
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_invoice_number
    BEFORE INSERT ON invoices
    FOR EACH ROW EXECUTE FUNCTION generate_invoice_number();
5. Backend Architecture
5.1 Django 6.0 Configuration
Python

# config/settings/base.py
"""
Django 6.0 Base Settings - TechFlow Solutions
Python 3.13 Required
"""

from pathlib import Path
from datetime import timedelta
import os

# Build paths
BASE_DIR = Path(__file__).resolve().parent.parent.parent

# =============================================================================
# CORE SETTINGS
# =============================================================================

DEBUG = False
ALLOWED_HOSTS = []
ROOT_URLCONF = 'config.urls'
WSGI_APPLICATION = 'config.wsgi.application'
ASGI_APPLICATION = 'config.asgi.application'

# Django 6.0: BigAutoField is now the default (no more warnings)
DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# =============================================================================
# INSTALLED APPLICATIONS
# =============================================================================

DJANGO_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'django.contrib.postgres',
]

THIRD_PARTY_APPS = [
    # API
    'rest_framework',
    'rest_framework_simplejwt',
    'corsheaders',
    'django_filters',
    
    # Real-time
    'channels',
    
    # Background Tasks
    'django_celery_beat',
    
    # API Documentation
    'drf_spectacular',
    
    # Storage
    'storages',
]

LOCAL_APPS = [
    'apps.core',
    'apps.identity',
    'apps.organizations',
    'apps.billing',
    'apps.workflows',
    'apps.analytics',
    'apps.compliance',
    'apps.notifications',
]

INSTALLED_APPS = DJANGO_APPS + THIRD_PARTY_APPS + LOCAL_APPS

# =============================================================================
# MIDDLEWARE
# =============================================================================

MIDDLEWARE = [
    # Security (first)
    'django.middleware.security.SecurityMiddleware',
    
    # Django 6.0: Built-in CSP
    'django.middleware.csp.ContentSecurityPolicyMiddleware',
    
    # CORS
    'corsheaders.middleware.CorsMiddleware',
    
    # Static files
    'whitenoise.middleware.WhiteNoiseMiddleware',
    
    # Standard Django
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    
    # Custom
    'apps.core.middleware.RequestIDMiddleware',
    'apps.core.middleware.TimezoneMiddleware',
    'apps.compliance.middleware.AuditLogMiddleware',
]

# =============================================================================
# DJANGO 6.0: CONTENT SECURITY POLICY
# =============================================================================

from django.utils.csp import CSP

SECURE_CSP = {
    "default-src": [CSP.SELF],
    "script-src": [CSP.SELF, CSP.NONCE],
    "style-src": [CSP.SELF, CSP.UNSAFE_INLINE],  # Required for Tailwind
    "img-src": [CSP.SELF, "https:", "data:"],
    "font-src": [CSP.SELF, "https://fonts.gstatic.com"],
    "connect-src": [CSP.SELF, "https://api.stripe.com"],
    "frame-src": ["https://js.stripe.com"],
    "object-src": [CSP.NONE],
    "base-uri": [CSP.SELF],
    "form-action": [CSP.SELF],
}

# For development/testing with violations logging
SECURE_CSP_REPORT_ONLY = None  # Set in production to report-uri

# =============================================================================
# TEMPLATES
# =============================================================================

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates'],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
                # Django 6.0: CSP nonce context processor
                'django.template.context_processors.csp',
            ],
        },
    },
]

# =============================================================================
# DATABASE
# =============================================================================

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql',
        'NAME': os.environ.get('DB_NAME', 'techflow'),
        'USER': os.environ.get('DB_USER', 'techflow'),
        'PASSWORD': os.environ.get('DB_PASSWORD', ''),
        'HOST': os.environ.get('DB_HOST', 'localhost'),
        'PORT': os.environ.get('DB_PORT', '5432'),
        'CONN_MAX_AGE': 60,
        'CONN_HEALTH_CHECKS': True,
        'OPTIONS': {
            'connect_timeout': 10,
        },
    }
}

# =============================================================================
# CACHE & SESSIONS
# =============================================================================

REDIS_URL = os.environ.get('REDIS_URL', 'redis://localhost:6379')

CACHES = {
    'default': {
        'BACKEND': 'django.core.cache.backends.redis.RedisCache',
        'LOCATION': f'{REDIS_URL}/0',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        },
        'KEY_PREFIX': 'techflow',
        'TIMEOUT': 300,
    }
}

SESSION_ENGINE = 'django.contrib.sessions.backends.cache'
SESSION_CACHE_ALIAS = 'default'
SESSION_COOKIE_SECURE = True
SESSION_COOKIE_HTTPONLY = True
SESSION_COOKIE_SAMESITE = 'Lax'
SESSION_COOKIE_AGE = 86400 * 7  # 7 days

# =============================================================================
# AUTHENTICATION
# =============================================================================

AUTH_USER_MODEL = 'identity.User'

AUTH_PASSWORD_VALIDATORS = [
    {'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator'},
    {'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator', 
     'OPTIONS': {'min_length': 12}},
    {'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator'},
    {'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator'},
]

# =============================================================================
# DJANGO REST FRAMEWORK
# =============================================================================

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': [
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ],
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.IsAuthenticated',
    ],
    'DEFAULT_RENDERER_CLASSES': [
        'rest_framework.renderers.JSONRenderer',
    ],
    'DEFAULT_PARSER_CLASSES': [
        'rest_framework.parsers.JSONParser',
        'rest_framework.parsers.MultiPartParser',
    ],
    'DEFAULT_FILTER_BACKENDS': [
        'django_filters.rest_framework.DjangoFilterBackend',
        'rest_framework.filters.SearchFilter',
        'rest_framework.filters.OrderingFilter',
    ],
    'DEFAULT_PAGINATION_CLASS': 'apps.core.pagination.StandardPagination',
    'PAGE_SIZE': 20,
    'DEFAULT_SCHEMA_CLASS': 'drf_spectacular.openapi.AutoSchema',
    'DEFAULT_THROTTLE_CLASSES': [
        'rest_framework.throttling.AnonRateThrottle',
        'rest_framework.throttling.UserRateThrottle',
    ],
    'DEFAULT_THROTTLE_RATES': {
        'anon': '100/hour',
        'user': '1000/hour',
    },
    'EXCEPTION_HANDLER': 'apps.core.exceptions.custom_exception_handler',
}

# JWT Settings
SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=15),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),
    'ROTATE_REFRESH_TOKENS': True,
    'BLACKLIST_AFTER_ROTATION': True,
    'UPDATE_LAST_LOGIN': True,
    'ALGORITHM': 'HS256',
    'AUTH_HEADER_TYPES': ('Bearer',),
}

# =============================================================================
# DJANGO 6.0: BACKGROUND TASKS
# =============================================================================

# Django's built-in Tasks framework (simple tasks)
TASKS = {
    'default': {
        'BACKEND': 'django.tasks.backends.database.DatabaseBackend',
    }
}

# Celery (complex tasks with retry, scheduling)
CELERY_BROKER_URL = f'{REDIS_URL}/1'
CELERY_RESULT_BACKEND = f'{REDIS_URL}/2'
CELERY_ACCEPT_CONTENT = ['json']
CELERY_TASK_SERIALIZER = 'json'
CELERY_RESULT_SERIALIZER = 'json'
CELERY_TIMEZONE = 'Asia/Singapore'
CELERY_TASK_TRACK_STARTED = True
CELERY_TASK_TIME_LIMIT = 300
CELERY_WORKER_PREFETCH_MULTIPLIER = 4
CELERY_BEAT_SCHEDULER = 'django_celery_beat.schedulers:DatabaseScheduler'

# =============================================================================
# DJANGO CHANNELS (WebSocket)
# =============================================================================

CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            'hosts': [REDIS_URL],
            'capacity': 1500,
            'expiry': 10,
        },
    },
}

# =============================================================================
# EMAIL (Django 6.0 Modern Email API)
# =============================================================================

EMAIL_BACKEND = 'django.core.mail.backends.smtp.EmailBackend'
EMAIL_HOST = 'smtp.sendgrid.net'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
EMAIL_HOST_USER = 'apikey'
EMAIL_HOST_PASSWORD = os.environ.get('SENDGRID_API_KEY', '')
DEFAULT_FROM_EMAIL = 'TechFlow <noreply@techflow.sg>'

# =============================================================================
# FILE STORAGE
# =============================================================================

STORAGES = {
    'default': {
        'BACKEND': 'storages.backends.s3boto3.S3Boto3Storage',
        'OPTIONS': {
            'bucket_name': os.environ.get('AWS_STORAGE_BUCKET_NAME', ''),
            'region_name': 'ap-southeast-1',
            'default_acl': 'private',
            'file_overwrite': False,
        },
    },
    'staticfiles': {
        'BACKEND': 'whitenoise.storage.CompressedManifestStaticFilesStorage',
    },
}

# =============================================================================
# STATIC & MEDIA
# =============================================================================

STATIC_URL = '/static/'
STATIC_ROOT = BASE_DIR / 'staticfiles'
STATICFILES_DIRS = [BASE_DIR / 'static']

MEDIA_URL = '/media/'
MEDIA_ROOT = BASE_DIR / 'media'

# =============================================================================
# INTERNATIONALIZATION (English Only)
# =============================================================================

LANGUAGE_CODE = 'en-sg'
TIME_ZONE = 'Asia/Singapore'
USE_I18N = False  # English only - simplified
USE_TZ = True

# =============================================================================
# SECURITY
# =============================================================================

SECURE_BROWSER_XSS_FILTER = True
SECURE_CONTENT_TYPE_NOSNIFF = True
X_FRAME_OPTIONS = 'DENY'
SECURE_REFERRER_POLICY = 'strict-origin-when-cross-origin'

# HTTPS (production)
SECURE_SSL_REDIRECT = True
SECURE_HSTS_SECONDS = 31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS = True
SECURE_HSTS_PRELOAD = True

# =============================================================================
# CORS
# =============================================================================

CORS_ALLOWED_ORIGINS = [
    'https://techflow.sg',
    'https://www.techflow.sg',
]
CORS_ALLOW_CREDENTIALS = True

# =============================================================================
# API DOCUMENTATION
# =============================================================================

SPECTACULAR_SETTINGS = {
    'TITLE': 'TechFlow API',
    'DESCRIPTION': 'Enterprise Workflow Automation Platform',
    'VERSION': '1.0.0',
    'SERVE_INCLUDE_SCHEMA': False,
    'COMPONENT_SPLIT_REQUEST': True,
    'SCHEMA_PATH_PREFIX': '/api/v1/',
}

# =============================================================================
# THIRD-PARTY SERVICES
# =============================================================================

# Stripe
STRIPE_PUBLISHABLE_KEY = os.environ.get('STRIPE_PUBLISHABLE_KEY', '')
STRIPE_SECRET_KEY = os.environ.get('STRIPE_SECRET_KEY', '')
STRIPE_WEBHOOK_SECRET = os.environ.get('STRIPE_WEBHOOK_SECRET', '')

# Sentry
SENTRY_DSN = os.environ.get('SENTRY_DSN', '')

# =============================================================================
# SINGAPORE-SPECIFIC
# =============================================================================

# Company Information
COMPANY_UEN = os.environ.get('COMPANY_UEN', '')
COMPANY_NAME = 'TechFlow Solutions Pte. Ltd.'
COMPANY_ADDRESS = '1 Marina Boulevard, Singapore 018989'

# GST Rate
GST_RATE = 0.09  # 9% as of 2024

# PDPA
PDPA_DPO_EMAIL = 'dpo@techflow.sg'
PDPA_DATA_RETENTION_DAYS = 2555  # 7 years

# =============================================================================
# LOGGING
# =============================================================================

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '{levelname} {asctime} {module} {process:d} {thread:d} {message}',
            'style': '{',
        },
        'json': {
            '()': 'pythonjsonlogger.jsonlogger.JsonFormatter',
            'format': '%(levelname)s %(asctime)s %(module)s %(message)s',
        },
    },
    'handlers': {
        'console': {
            'class': 'logging.StreamHandler',
            'formatter': 'verbose',
        },
        'json_console': {
            'class': 'logging.StreamHandler',
            'formatter': 'json',
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO',
    },
    'loggers': {
        'django': {
            'handlers': ['console'],
            'level': 'INFO',
            'propagate': False,
        },
        'apps': {
            'handlers': ['json_console'],
            'level': 'DEBUG',
            'propagate': False,
        },
    },
}
5.2 Core Models
Python

# apps/core/models.py
"""
Abstract base models with common functionality
"""
import uuid
from django.db import models
from django.utils import timezone


class TimeStampedModel(models.Model):
    """Abstract model with created/updated timestamps"""
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        abstract = True


class UUIDModel(models.Model):
    """Abstract model with UUID primary key"""
    
    id = models.UUIDField(
        primary_key=True,
        default=uuid.uuid4,
        editable=False
    )
    
    class Meta:
        abstract = True


class BaseModel(UUIDModel, TimeStampedModel):
    """Base model combining UUID and timestamps"""
    
    class Meta:
        abstract = True


class SoftDeleteModel(models.Model):
    """Abstract model with soft delete capability"""
    
    deleted_at = models.DateTimeField(null=True, blank=True)
    
    class Meta:
        abstract = True
    
    def soft_delete(self):
        self.deleted_at = timezone.now()
        self.save(update_fields=['deleted_at'])
    
    def restore(self):
        self.deleted_at = None
        self.save(update_fields=['deleted_at'])
    
    @property
    def is_deleted(self):
        return self.deleted_at is not None


class SoftDeleteManager(models.Manager):
    """Manager that excludes soft-deleted records"""
    
    def get_queryset(self):
        return super().get_queryset().filter(deleted_at__isnull=True)
    
    def with_deleted(self):
        return super().get_queryset()
    
    def deleted_only(self):
        return super().get_queryset().filter(deleted_at__isnull=False)
5.3 User Model
Python

# apps/identity/models.py
"""
Custom User model with Singapore-specific considerations
"""
from django.contrib.auth.models import AbstractBaseUser, PermissionsMixin, BaseUserManager
from django.db import models
from django.utils import timezone
from apps.core.models import BaseModel


class UserManager(BaseUserManager):
    """Custom user manager"""
    
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError('Email is required')
        
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user
    
    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('email_verified', True)
        
        return self.create_user(email, password, **extra_fields)


class User(AbstractBaseUser, PermissionsMixin, BaseModel):
    """
    Custom User model
    
    - Email-based authentication
    - Singapore timezone default
    - MFA support
    """
    
    # Authentication
    email = models.EmailField(unique=True, db_index=True)
    password = models.CharField(max_length=255)  # Renamed from password_hash
    
    # Profile
    full_name = models.CharField(max_length=255)
    avatar_url = models.URLField(blank=True, null=True)
    phone_number = models.CharField(max_length=20, blank=True, null=True)
    
    # Status
    is_active = models.BooleanField(default=True)
    is_staff = models.BooleanField(default=False)
    email_verified = models.BooleanField(default=False)
    
    # Security
    mfa_enabled = models.BooleanField(default=False)
    mfa_secret = models.CharField(max_length=255, blank=True, null=True)
    failed_login_attempts = models.PositiveIntegerField(default=0)
    locked_until = models.DateTimeField(null=True, blank=True)
    
    # Preferences
    timezone = models.CharField(max_length=50, default='Asia/Singapore')
    preferences = models.JSONField(default=dict)
    
    # Tracking
    last_login_at = models.DateTimeField(null=True, blank=True)
    password_changed_at = models.DateTimeField(null=True, blank=True)
    
    objects = UserManager()
    
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = ['full_name']
    
    class Meta:
        db_table = 'users'
        verbose_name = 'user'
        verbose_name_plural = 'users'
    
    def __str__(self):
        return self.email
    
    @property
    def is_locked(self):
        if self.locked_until is None:
            return False
        return timezone.now() < self.locked_until
    
    def record_login_failure(self):
        self.failed_login_attempts += 1
        if self.failed_login_attempts >= 5:
            self.locked_until = timezone.now() + timezone.timedelta(minutes=30)
        self.save(update_fields=['failed_login_attempts', 'locked_until'])
    
    def record_login_success(self):
        self.failed_login_attempts = 0
        self.locked_until = None
        self.last_login_at = timezone.now()
        self.save(update_fields=['failed_login_attempts', 'locked_until', 'last_login_at'])


class Session(BaseModel):
    """User session tracking"""
    
    user = models.ForeignKey(
        User,
        on_delete=models.CASCADE,
        related_name='sessions'
    )
    token_hash = models.CharField(max_length=255, unique=True)
    
    # Context
    ip_address = models.GenericIPAddressField(null=True)
    user_agent = models.TextField(blank=True, null=True)
    device_type = models.CharField(max_length=50, blank=True, null=True)
    
    # Validity
    expires_at = models.DateTimeField()
    last_activity_at = models.DateTimeField(auto_now=True)
    
    class Meta:
        db_table = 'sessions'
        indexes = [
            models.Index(fields=['token_hash']),
            models.Index(fields=['user', 'expires_at']),
        ]
    
    @property
    def is_expired(self):
        return timezone.now() > self.expires_at
5.4 Django 6.0 Background Tasks
Python

# apps/notifications/tasks.py
"""
Background tasks using Django 6.0's built-in Tasks framework
and Celery for complex operations
"""
from django.tasks import task
from django.core.mail import send_mail
from django.template.loader import render_to_string
from django.conf import settings
import logging

logger = logging.getLogger(__name__)


# =============================================================================
# DJANGO 6.0 TASKS (Simple, fire-and-forget)
# =============================================================================

@task
def send_welcome_email(user_id: str, verification_url: str):
    """
    Send welcome email to new user
    Using Django 6.0's built-in @task decorator
    """
    from apps.identity.models import User
    
    user = User.objects.get(id=user_id)
    
    html_message = render_to_string('emails/welcome.html', {
        'user': user,
        'verification_url': verification_url,
    })
    
    send_mail(
        subject='Welcome to TechFlow',
        message='',  # Plain text fallback
        from_email=settings.DEFAULT_FROM_EMAIL,
        recipient_list=[user.email],
        html_message=html_message,
    )
    
    logger.info(f"Welcome email sent to {user.email}")


@task
def send_password_reset_email(user_id: str, reset_url: str):
    """Send password reset email"""
    from apps.identity.models import User
    
    user = User.objects.get(id=user_id)
    
    html_message = render_to_string('emails/password_reset.html', {
        'user': user,
        'reset_url': reset_url,
    })
    
    send_mail(
        subject='Reset Your TechFlow Password',
        message='',
        from_email=settings.DEFAULT_FROM_EMAIL,
        recipient_list=[user.email],
        html_message=html_message,
    )


@task
def send_invitation_email(invitation_id: str):
    """Send team invitation email"""
    from apps.organizations.models import Invitation
    
    invitation = Invitation.objects.select_related(
        'organization', 'invited_by'
    ).get(id=invitation_id)
    
    html_message = render_to_string('emails/invitation.html', {
        'invitation': invitation,
        'accept_url': f"{settings.FRONTEND_URL}/invitations/{invitation.token}",
    })
    
    send_mail(
        subject=f"You're invited to join {invitation.organization.name} on TechFlow",
        message='',
        from_email=settings.DEFAULT_FROM_EMAIL,
        recipient_list=[invitation.email],
        html_message=html_message,
    )


@task
def create_audit_log(
    user_id: str | None,
    organization_id: str | None,
    action: str,
    category: str,
    resource_type: str | None = None,
    resource_id: str | None = None,
    details: dict | None = None,
    ip_address: str | None = None,
    user_agent: str | None = None,
    request_id: str | None = None,
):
    """
    Create audit log entry asynchronously
    This keeps the main request fast while ensuring compliance
    """
    from apps.compliance.models import AuditLog
    
    AuditLog.objects.create(
        user_id=user_id,
        organization_id=organization_id,
        action=action,
        category=category,
        resource_type=resource_type,
        resource_id=resource_id,
        details=details or {},
        ip_address=ip_address,
        user_agent=user_agent,
        request_id=request_id,
    )


# =============================================================================
# USAGE EXAMPLES
# =============================================================================

# In a view or service:
# 
# from apps.notifications.tasks import send_welcome_email
# 
# # Enqueue task (Django 6.0 syntax)
# send_welcome_email.enqueue(
#     user_id=str(user.id),
#     verification_url=verification_url
# )
Python

# apps/workflows/tasks.py
"""
Complex background tasks using Celery
For tasks that need retry, scheduling, or result tracking
"""
from celery import shared_task
from celery.utils.log import get_task_logger
from django.utils import timezone
from typing import Any
import json

logger = get_task_logger(__name__)


@shared_task(
    bind=True,
    autoretry_for=(Exception,),
    retry_kwargs={'max_retries': 3, 'countdown': 60},
    retry_backoff=True,
)
def execute_workflow(self, execution_id: str):
    """
    Execute a workflow
    Uses Celery for retry logic and result tracking
    """
    from apps.workflows.models import WorkflowExecution
    from apps.workflows.engine.executor import WorkflowExecutor
    
    execution = WorkflowExecution.objects.select_related('workflow').get(id=execution_id)
    
    # Update status
    execution.status = 'running'
    execution.started_at = timezone.now()
    execution.save(update_fields=['status', 'started_at'])
    
    try:
        executor = WorkflowExecutor(execution)
        result = executor.run()
        
        execution.status = 'completed'
        execution.output_data = result
        execution.completed_at = timezone.now()
        execution.duration_ms = int(
            (execution.completed_at - execution.started_at).total_seconds() * 1000
        )
        execution.save()
        
        # Update workflow stats
        workflow = execution.workflow
        workflow.total_executions += 1
        workflow.successful_executions += 1
        workflow.save(update_fields=['total_executions', 'successful_executions'])
        
        logger.info(f"Workflow execution {execution_id} completed successfully")
        return {'status': 'success', 'execution_id': str(execution_id)}
        
    except Exception as e:
        execution.status = 'failed'
        execution.error_message = str(e)
        execution.error_details = {'traceback': self.request.traceback}
        execution.completed_at = timezone.now()
        execution.save()
        
        # Update workflow stats
        workflow = execution.workflow
        workflow.total_executions += 1
        workflow.save(update_fields=['total_executions'])
        
        logger.error(f"Workflow execution {execution_id} failed: {e}")
        raise


@shared_task
def process_scheduled_workflows():
    """
    Check for workflows due to run and trigger them
    Called by Celery Beat every minute
    """
    from apps.workflows.models import Workflow, WorkflowExecution
    
    now = timezone.now()
    
    # Find active workflows due to run
    due_workflows = Workflow.objects.filter(
        status='active',
        schedule__isnull=False,
        next_run_at__lte=now,
    )
    
    triggered_count = 0
    
    for workflow in due_workflows:
        # Create execution
        execution = WorkflowExecution.objects.create(
            workflow=workflow,
            organization=workflow.organization,
            triggered_by='schedule',
        )
        
        # Enqueue execution
        execute_workflow.delay(str(execution.id))
        
        # Calculate next run time
        workflow.next_run_at = workflow.calculate_next_run()
        workflow.save(update_fields=['next_run_at'])
        
        triggered_count += 1
    
    if triggered_count > 0:
        logger.info(f"Triggered {triggered_count} scheduled workflows")
    
    return {'triggered': triggered_count}


@shared_task
def calculate_daily_usage():
    """
    Calculate and store daily usage metrics for all organizations
    Runs at midnight Singapore time
    """
    from apps.organizations.models import Organization
    from apps.analytics.models import UsageRecord
    from apps.workflows.models import WorkflowExecution
    from django.db.models import Count, Sum
    
    yesterday = timezone.now().date() - timezone.timedelta(days=1)
    period_start = timezone.make_aware(
        timezone.datetime.combine(yesterday, timezone.datetime.min.time())
    )
    period_end = period_start + timezone.timedelta(days=1)
    
    for org in Organization.objects.filter(is_active=True):
        # Count workflow executions
        execution_count = WorkflowExecution.objects.filter(
            organization=org,
            created_at__gte=period_start,
            created_at__lt=period_end,
        ).count()
        
        if execution_count > 0:
            UsageRecord.objects.create(
                organization=org,
                metric_type='workflow_executions',
                quantity=execution_count,
                period_start=period_start,
                period_end=period_end,
            )
    
    logger.info(f"Calculated daily usage for {yesterday}")


@shared_task
def cleanup_expired_sessions():
    """Clean up expired sessions - runs hourly"""
    from apps.identity.models import Session
    
    deleted_count, _ = Session.objects.filter(
        expires_at__lt=timezone.now()
    ).delete()
    
    if deleted_count > 0:
        logger.info(f"Cleaned up {deleted_count} expired sessions")
    
    return {'deleted': deleted_count}


@shared_task
def cleanup_expired_invitations():
    """Clean up expired invitations - runs daily"""
    from apps.organizations.models import Invitation
    
    # Mark expired invitations
    expired_count = Invitation.objects.filter(
        status='pending',
        expires_at__lt=timezone.now(),
    ).update(status='expired')
    
    if expired_count > 0:
        logger.info(f"Marked {expired_count} invitations as expired")
    
    return {'expired': expired_count}


@shared_task
def generate_invoice(organization_id: str, subscription_id: str):
    """Generate invoice for subscription payment"""
    from apps.billing.services.invoice import InvoiceService
    
    service = InvoiceService()
    invoice = service.generate_for_subscription(
        organization_id=organization_id,
        subscription_id=subscription_id,
    )
    
    logger.info(f"Generated invoice {invoice.invoice_number}")
    return {'invoice_id': str(invoice.id), 'invoice_number': invoice.invoice_number}


# =============================================================================
# CELERY BEAT SCHEDULE
# =============================================================================

CELERY_BEAT_SCHEDULE = {
    'process-scheduled-workflows': {
        'task': 'apps.workflows.tasks.process_scheduled_workflows',
        'schedule': 60.0,  # Every minute
    },
    'calculate-daily-usage': {
        'task': 'apps.workflows.tasks.calculate_daily_usage',
        'schedule': {
            'hour': 0,
            'minute': 5,
        },  # Daily at 00:05 Singapore time
    },
    'cleanup-expired-sessions': {
        'task': 'apps.workflows.tasks.cleanup_expired_sessions',
        'schedule': 3600.0,  # Every hour
    },
    'cleanup-expired-invitations': {
        'task': 'apps.workflows.tasks.cleanup_expired_invitations',
        'schedule': 86400.0,  # Daily
    },
}
5.5 Service Layer Pattern
Python

# apps/billing/services/subscription.py
"""
Subscription service with business logic
"""
from decimal import Decimal
from typing import Optional
from django.db import transaction
from django.utils import timezone
from django.conf import settings
from apps.organizations.models import Organization
from apps.billing.models import Subscription, Payment
from apps.billing.services.stripe import StripeService
from apps.billing.services.paynow import PayNowService
import logging

logger = logging.getLogger(__name__)


class SubscriptionError(Exception):
    """Base exception for subscription errors"""
    pass


class SubscriptionService:
    """
    Subscription management service
    
    Handles:
    - Plan upgrades/downgrades
    - Payment processing (Stripe + PayNow)
    - Usage limit enforcement
    - Billing calculations (with GST)
    """
    
    PLAN_LIMITS = {
        'free': {
            'max_users': 3,
            'max_workflows': 5,
            'max_api_calls': 1000,
            'max_storage_bytes': 500 * 1024 * 1024,  # 500 MB
            'price_cents': 0,
        },
        'starter': {
            'max_users': 10,
            'max_workflows': 25,
            'max_api_calls': 10000,
            'max_storage_bytes': 5 * 1024 * 1024 * 1024,  # 5 GB
            'price_cents': 4900,  # $49 SGD
        },
        'professional': {
            'max_users': 50,
            'max_workflows': 100,
            'max_api_calls': 100000,
            'max_storage_bytes': 50 * 1024 * 1024 * 1024,  # 50 GB
            'price_cents': 19900,  # $199 SGD
        },
        'enterprise': {
            'max_users': -1,  # Unlimited
            'max_workflows': -1,
            'max_api_calls': -1,
            'max_storage_bytes': 500 * 1024 * 1024 * 1024,  # 500 GB
            'price_cents': 0,  # Custom pricing
        },
    }
    
    def __init__(self, organization: Organization):
        self.organization = organization
        self.stripe = StripeService()
        self.paynow = PayNowService()
    
    def get_current_subscription(self) -> Optional[Subscription]:
        """Get current active subscription"""
        try:
            return Subscription.objects.get(organization=self.organization)
        except Subscription.DoesNotExist:
            return None
    
    @transaction.atomic
    def create_subscription(self, tier: str = 'free') -> Subscription:
        """Create initial subscription for organization"""
        if tier not in self.PLAN_LIMITS:
            raise SubscriptionError(f"Invalid tier: {tier}")
        
        limits = self.PLAN_LIMITS[tier]
        
        subscription = Subscription.objects.create(
            organization=self.organization,
            tier=tier,
            status='active' if tier == 'free' else 'trialing',
            trial_start=timezone.now() if tier != 'free' else None,
            trial_end=timezone.now() + timezone.timedelta(days=14) if tier != 'free' else None,
            max_users=limits['max_users'],
            max_workflows=limits['max_workflows'],
            max_api_calls=limits['max_api_calls'],
            max_storage_bytes=limits['max_storage_bytes'],
        )
        
        logger.info(f"Created {tier} subscription for org {self.organization.id}")
        return subscription
    
    @transaction.atomic
    def upgrade_subscription(
        self,
        new_tier: str,
        payment_method: str = 'stripe',
    ) -> Subscription:
        """
        Upgrade subscription to new tier
        
        Args:
            new_tier: Target subscription tier
            payment_method: 'stripe' or 'paynow'
        
        Returns:
            Updated subscription
        """
        if new_tier not in self.PLAN_LIMITS:
            raise SubscriptionError(f"Invalid tier: {new_tier}")
        
        subscription = self.get_current_subscription()
        if not subscription:
            raise SubscriptionError("No subscription found")
        
        if new_tier == 'free':
            raise SubscriptionError("Cannot downgrade to free tier via upgrade")
        
        limits = self.PLAN_LIMITS[new_tier]
        
        # Calculate prorated amount if upgrading mid-cycle
        amount_cents = self._calculate_upgrade_amount(subscription, new_tier)
        
        # Process payment
        if amount_cents > 0:
            if payment_method == 'stripe':
                payment = self._process_stripe_payment(amount_cents, new_tier)
            elif payment_method == 'paynow':
                payment = self._process_paynow_payment(amount_cents, new_tier)
            else:
                raise SubscriptionError(f"Invalid payment method: {payment_method}")
        
        # Update subscription
        subscription.tier = new_tier
        subscription.status = 'active'
        subscription.max_users = limits['max_users']
        subscription.max_workflows = limits['max_workflows']
        subscription.max_api_calls = limits['max_api_calls']
        subscription.max_storage_bytes = limits['max_storage_bytes']
        subscription.current_period_start = timezone.now()
        subscription.current_period_end = timezone.now() + timezone.timedelta(days=30)
        subscription.save()
        
        logger.info(f"Upgraded org {self.organization.id} to {new_tier}")
        return subscription
    
    def check_limit(self, resource: str, quantity: int = 1) -> bool:
        """
        Check if usage is within subscription limits
        
        Args:
            resource: 'users', 'workflows', 'api_calls', 'storage_bytes'
            quantity: Amount to check (default 1)
        
        Returns:
            True if within limits
        """
        subscription = self.get_current_subscription()
        if not subscription:
            return False
        
        limit_field = f'max_{resource}'
        limit = getattr(subscription, limit_field, 0)
        
        # -1 means unlimited
        if limit == -1:
            return True
        
        current_usage = self._get_current_usage(resource)
        return (current_usage + quantity) <= limit
    
    def get_usage_summary(self) -> dict:
        """Get current usage vs limits"""
        subscription = self.get_current_subscription()
        if not subscription:
            return {}
        
        return {
            'users': {
                'current': self._get_current_usage('users'),
                'limit': subscription.max_users,
            },
            'workflows': {
                'current': self._get_current_usage('workflows'),
                'limit': subscription.max_workflows,
            },
            'api_calls': {
                'current': self._get_current_usage('api_calls'),
                'limit': subscription.max_api_calls,
            },
            'storage_bytes': {
                'current': self._get_current_usage('storage_bytes'),
                'limit': subscription.max_storage_bytes,
            },
        }
    
    def _get_current_usage(self, resource: str) -> int:
        """Get current usage for a resource"""
        if resource == 'users':
            return self.organization.members.filter(is_active=True).count()
        elif resource == 'workflows':
            return self.organization.workflows.filter(status__in=['draft', 'active']).count()
        elif resource == 'api_calls':
            # Get current month's API calls from usage records
            from apps.analytics.models import UsageRecord
            from django.db.models import Sum
            
            start_of_month = timezone.now().replace(day=1, hour=0, minute=0, second=0, microsecond=0)
            result = UsageRecord.objects.filter(
                organization=self.organization,
                metric_type='api_calls',
                period_start__gte=start_of_month,
            ).aggregate(total=Sum('quantity'))
            
            return int(result['total'] or 0)
        else:
            return 0
    
    def _calculate_upgrade_amount(self, subscription: Subscription, new_tier: str) -> int:
        """Calculate prorated upgrade amount in cents"""
        new_price = self.PLAN_LIMITS[new_tier]['price_cents']
        old_price = self.PLAN_LIMITS[subscription.tier]['price_cents']
        
        if subscription.current_period_end and subscription.current_period_start:
            # Calculate remaining days
            total_days = (subscription.current_period_end - subscription.current_period_start).days
            remaining_days = (subscription.current_period_end - timezone.now()).days
            
            if remaining_days > 0 and total_days > 0:
                # Prorate the difference
                daily_difference = (new_price - old_price) / total_days
                return int(daily_difference * remaining_days)
        
        return new_price
    
    def _process_stripe_payment(self, amount_cents: int, tier: str) -> Payment:
        """Process payment via Stripe"""
        # Add GST
        gst_cents = int(amount_cents * settings.GST_RATE)
        total_cents = amount_cents + gst_cents
        
        stripe_payment = self.stripe.create_payment(
            amount_cents=total_cents,
            currency='SGD',
            customer_id=self.organization.subscription.stripe_customer_id,
            description=f"TechFlow {tier.title()} Plan",
        )
        
        payment = Payment.objects.create(
            organization=self.organization,
            subscription=self.organization.subscription,
            method='stripe',
            status='completed',
            amount_cents=total_cents,
            currency='SGD',
            stripe_payment_id=stripe_payment.id,
            paid_at=timezone.now(),
        )
        
        return payment
    
    def _process_paynow_payment(self, amount_cents: int, tier: str) -> Payment:
        """Generate PayNow QR for payment (async confirmation)"""
        gst_cents = int(amount_cents * settings.GST_RATE)
        total_cents = amount_cents + gst_cents
        
        payment = Payment.objects.create(
            organization=self.organization,
            subscription=self.organization.subscription,
            method='paynow',
            status='pending',
            amount_cents=total_cents,
            currency='SGD',
            description=f"TechFlow {tier.title()} Plan",
        )
        
        # Generate PayNow QR
        qr_data = self.paynow.generate_qr(
            amount_cents=total_cents,
            reference=str(payment.id),
        )
        
        payment.paynow_reference = qr_data['reference']
        payment.save(update_fields=['paynow_reference'])
        
        return payment
6. Frontend Architecture
6.1 Next.js 15 Configuration
TypeScript

// next.config.ts
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  // React 19 with Server Components
  reactStrictMode: true,
  
  // Optimizations
  poweredByHeader: false,
  compress: true,
  
  // Images
  images: {
    remotePatterns: [
      {
        protocol: 'https',
        hostname: 'techflow-assets.s3.ap-southeast-1.amazonaws.com',
      },
    ],
    formats: ['image/avif', 'image/webp'],
  },
  
  // Environment
  env: {
    NEXT_PUBLIC_API_URL: process.env.NEXT_PUBLIC_API_URL,
    NEXT_PUBLIC_WS_URL: process.env.NEXT_PUBLIC_WS_URL,
    NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY: process.env.NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY,
  },
  
  // Security Headers
  async headers() {
    return [
      {
        source: '/:path*',
        headers: [
          { key: 'X-DNS-Prefetch-Control', value: 'on' },
          { key: 'Strict-Transport-Security', value: 'max-age=31536000; includeSubDomains' },
          { key: 'X-Frame-Options', value: 'DENY' },
          { key: 'X-Content-Type-Options', value: 'nosniff' },
          { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },
          { key: 'Permissions-Policy', value: 'camera=(), microphone=(), geolocation=()' },
        ],
      },
    ];
  },
  
  // Redirects
  async redirects() {
    return [
      {
        source: '/app',
        destination: '/dashboard',
        permanent: true,
      },
    ];
  },
  
  // Experimental features
  experimental: {
    // Enable React 19 features
    reactCompiler: true,
  },
};

export default nextConfig;
6.2 API Client
TypeScript

// src/lib/api/client.ts
import { QueryClient } from '@tanstack/react-query';

const API_URL = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:8000/api/v1';

// =============================================================================
// TOKEN MANAGEMENT
// =============================================================================

let accessToken: string | null = null;
let refreshToken: string | null = null;

export const tokenManager = {
  setTokens(access: string, refresh: string) {
    accessToken = access;
    refreshToken = refresh;
    
    // Store in localStorage for persistence
    if (typeof window !== 'undefined') {
      localStorage.setItem('access_token', access);
      localStorage.setItem('refresh_token', refresh);
    }
  },
  
  getAccessToken() {
    if (accessToken) return accessToken;
    if (typeof window !== 'undefined') {
      return localStorage.getItem('access_token');
    }
    return null;
  },
  
  getRefreshToken() {
    if (refreshToken) return refreshToken;
    if (typeof window !== 'undefined') {
      return localStorage.getItem('refresh_token');
    }
    return null;
  },
  
  clearTokens() {
    accessToken = null;
    refreshToken = null;
    if (typeof window !== 'undefined') {
      localStorage.removeItem('access_token');
      localStorage.removeItem('refresh_token');
    }
  },
};

// =============================================================================
// FETCH WRAPPER
// =============================================================================

interface FetchOptions extends RequestInit {
  skipAuth?: boolean;
}

interface ApiError {
  message: string;
  code?: string;
  details?: Record<string, string[]>;
}

class ApiClient {
  private baseUrl: string;
  private isRefreshing = false;
  private refreshPromise: Promise<boolean> | null = null;
  
  constructor(baseUrl: string) {
    this.baseUrl = baseUrl;
  }
  
  private async refreshAccessToken(): Promise<boolean> {
    const refresh = tokenManager.getRefreshToken();
    if (!refresh) return false;
    
    try {
      const response = await fetch(`${this.baseUrl}/auth/token/refresh/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ refresh }),
      });
      
      if (!response.ok) {
        tokenManager.clearTokens();
        return false;
      }
      
      const data = await response.json();
      tokenManager.setTokens(data.access, data.refresh);
      return true;
    } catch {
      tokenManager.clearTokens();
      return false;
    }
  }
  
  async fetch<T>(endpoint: string, options: FetchOptions = {}): Promise<T> {
    const { skipAuth = false, ...fetchOptions } = options;
    
    const headers: HeadersInit = {
      'Content-Type': 'application/json',
      ...fetchOptions.headers,
    };
    
    if (!skipAuth) {
      const token = 
